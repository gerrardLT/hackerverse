# HackX 去中心化黑客松平台 - 技术方案与架构设计

## 项目概述

基于区块链和IPFS的去中心化黑客松平台，支持黑客松创建、项目提交、用户管理等功能，服务全球数百万开发者，实现真正的Web3原生体验。

### 产品愿景
构建首个完全基于区块链和IPFS的去中心化黑客松平台，支持100+场黑客松、服务全球数百万开发者，实现真正的Web3原生体验。

### 核心用户群体
- **黑客松参与者 (Developer)**: 18-35岁，软件开发者、学生、创业者、Web3开发者
- **黑客松组织者 (Organizer)**: 25-45岁，技术公司、投资机构负责人、Web3项目方
- **评委 (Judge)**: 30-50岁，技术专家、投资人、行业领袖、Web3专家
- **投资者/企业 (Investor)**: 35-60岁，风险投资人、企业技术负责人、Web3基金

## 技术栈选择

### 前端技术栈
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS + shadcn/ui
- **状态管理**: Zustand
- **表单处理**: React Hook Form + Zod
- **UI组件**: Radix UI
- **图标**: Lucide React
- **动画**: Framer Motion
- **Web3集成**: ethers.js / viem + wagmi
- **钱包连接**: WalletConnect v2
- **实时通信**: Socket.io / Pusher

### 后端技术栈
- **运行时**: Node.js
- **框架**: Next.js API Routes
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **文件存储**: IPFS (通过 Pinata API)
- **认证**: NextAuth.js + Web3认证
- **Web3集成**: ethers.js / viem
- **邮件服务**: Resend / SendGrid
- **通知服务**: WebPush API

### 区块链技术栈
- **智能合约**: Solidity 0.8.x
- **开发框架**: Hardhat
- **测试框架**: Chai + Mocha
- **部署工具**: Hardhat Deploy
- **验证工具**: Hardhat Etherscan
- **Gas优化**: Solhint + Gas Reporter

### 去中心化存储
- **IPFS客户端**: ipfs-http-client
- **IPFS网关**: Pinata / Infura
- **数据索引**: The Graph Protocol
- **GraphQL客户端**: Apollo Client

### 基础设施
- **部署**: Vercel (前端) + Railway (后端)
- **数据库**: Supabase / PlanetScale
- **IPFS网关**: Pinata / Infura
- **监控**: Vercel Analytics + Sentry
- **CI/CD**: GitHub Actions
- **CDN**: Vercel Edge Network

## 系统架构设计

### 去中心化架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Next.js) │    │   智能合约      │    │   IPFS 存储     │
│                 │    │                 │    │                 │
│ - Web3集成      │◄──►│ - 用户管理      │◄──►│ - 用户资料      │
│ - 钱包连接      │    │ - 黑客松管理    │    │ - 项目文件      │
│ - 实时更新      │    │ - 项目管理      │    │ - 活动数据      │
│ - 主题系统      │    │ - 评分系统      │    │ - 评审反馈      │
│ - GraphQL查询   │    │ - DAO治理       │    │ - NFT元数据     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   The Graph     │    │   DAO 治理      │    │   NFT 系统      │
│                 │    │                 │    │                 │
│ - 数据索引      │    │ - 提案投票      │    │ - 成就证书      │
│ - GraphQL API   │    │ - 社区决策      │    │ - 参与证明      │
│ - 实时查询      │    │ - 资金管理      │    │ - 收藏品        │
│ - 事件监听      │    │ - 治理代币      │    │ - 稀有徽章      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 核心模块设计

#### 1. 智能合约架构
```solidity
// HackXCore.sol - 核心智能合约
contract HackXCore is Ownable {
    // 状态变量
    mapping(address => string) public userProfiles;
    mapping(uint256 => string) public hackathonData;
    mapping(uint256 => string) public projectData;
    mapping(uint256 => mapping(address => string)) public projectSubmissions;
    mapping(uint256 => address[]) public hackathonParticipants;
    mapping(address => uint256[]) public userHackathons;
    
    // 计数器
    uint256 public hackathonCount;
    uint256 public projectCount;
    
    // 事件
    event UserRegistered(address indexed user, string profileCID);
    event HackathonCreated(uint256 indexed hackathonId, address indexed organizer, string dataCID);
    event ProjectSubmitted(uint256 indexed projectId, address indexed submitter, string dataCID);
    event ScoreSubmitted(uint256 indexed projectId, address indexed judge, uint256 score);
    
    // 核心功能
    function registerUser(string memory profileCID) external;
    function createHackathon(string memory hackathonDataCID) external returns (uint256);
    function submitProject(uint256 hackathonId, string memory projectDataCID) external returns (uint256);
    function submitScore(uint256 projectId, uint256 score) external;
    
    // 查询功能
    function getUserProfile(address user) external view returns (string memory);
    function getHackathonData(uint256 hackathonId) external view returns (string memory);
    function getProjectData(uint256 projectId) external view returns (string memory);
}
```

#### 2. 用户认证模块
```typescript
// 多认证方式支持
interface AuthFlow {
  // 传统邮箱认证
  emailAuth: {
    signIn: (email: string, password: string) => Promise<User>
    signUp: (userData: UserRegistration) => Promise<User>
    resetPassword: (email: string) => Promise<void>
    verifyEmail: (token: string) => Promise<boolean>
  }
  
  // Web3钱包认证
  web3Auth: {
    connectWallet: (provider: 'metamask' | 'walletconnect') => Promise<User>
    verifySignature: (message: string, signature: string) => Promise<boolean>
    linkWallet: (walletAddress: string) => Promise<void>
    registerOnChain: (profileCID: string) => Promise<void>
  }
  
  // 社交登录
  socialAuth: {
    signInWithGitHub: () => Promise<User>
    signInWithGoogle: () => Promise<User>
    linkSocialAccount: (provider: string, accountId: string) => Promise<void>
  }
}
```

#### 3. 黑客松管理模块
```typescript
interface Hackathon {
  id: string
  title: string
  description: string
  startDate: Date
  endDate: Date
  registrationDeadline: Date
  status: 'draft' | 'upcoming' | 'ongoing' | 'ended'
  organizerId: string
  organizerAddress: string // 链上地址
  prizes: Prize[]
  judges: Judge[]
  tracks: Track[]
  rules: string
  requirements: string[]
  ipfsHash: string // IPFS存储哈希
  contractAddress: string // 智能合约地址
  metadata: HackathonMetadata
  participants: Participant[]
  projects: Project[]
  chainId: number // 区块链网络ID
}

interface HackathonMetadata {
  coverImage: string
  bannerImage: string
  socialLinks: SocialLinks
  sponsors: Sponsor[]
  schedule: ScheduleItem[]
  judgingCriteria: JudgingCriteria[]
  submissionGuidelines: string
  faq: FAQItem[]
  daoProposals: DAOProposal[]
}
```

#### 4. 项目提交模块
```typescript
interface Project {
  id: string
  name: string
  description: string
  team: TeamMember[]
  hackathonId: string
  track: string
  githubUrl?: string
  demoUrl?: string
  videoUrl?: string
  presentationUrl?: string
  ipfsHash: string // 项目文件IPFS哈希
  contractAddress: string // 智能合约地址
  status: 'draft' | 'submitted' | 'under_review' | 'approved' | 'rejected'
  scores: Score[]
  feedback: Feedback[]
  tags: string[]
  technologies: string[]
  nftCertificate?: string // NFT证书地址
  createdAt: Date
  updatedAt: Date
  chainId: number
}

interface TeamMember {
  id: string
  userId: string
  walletAddress: string
  role: 'leader' | 'developer' | 'designer' | 'other'
  contribution: string
  joinedAt: Date
}
```

#### 5. 用户管理模块
```typescript
interface User {
  id: string
  email: string
  username: string
  avatarUrl?: string
  bio?: string
  walletAddress?: string
  reputationScore: number
  badges: Badge[]
  skills: Skill[]
  socialLinks: SocialLinks
  ipfsProfileHash: string
  privacySettings: PrivacySettings
  notificationSettings: NotificationSettings
  web3Assets: Web3Assets
  createdAt: Date
  updatedAt: Date
}

interface Web3Assets {
  governanceTokens: number
  nftCollection: NFT[]
  stakingRecord: StakingRecord[]
  votingHistory: VotingRecord[]
  daoProposals: DAOProposal[]
}

interface Skill {
  id: string
  name: string
  level: 'beginner' | 'intermediate' | 'advanced' | 'expert'
  category: 'programming' | 'design' | 'business' | 'blockchain' | 'other'
}
```

#### 6. Web3功能模块
```typescript
// DAO治理系统
interface DAOGovernance {
  proposals: DAOProposal[]
  votingPower: (address: string) => Promise<number>
  createProposal: (proposal: ProposalData) => Promise<string>
  vote: (proposalId: string, support: boolean) => Promise<void>
  executeProposal: (proposalId: string) => Promise<void>
}

// NFT证书系统
interface NFTCertificates {
  mintCertificate: (userAddress: string, certificateData: CertificateData) => Promise<string>
  getCertificates: (userAddress: string) => Promise<NFT[]>
  verifyCertificate: (tokenId: string) => Promise<boolean>
  transferCertificate: (from: string, to: string, tokenId: string) => Promise<void>
}

// 质押奖励系统
interface StakingSystem {
  stake: (amount: number) => Promise<void>
  unstake: (amount: number) => Promise<void>
  claimRewards: () => Promise<number>
  getStakingInfo: (address: string) => Promise<StakingInfo>
}
```

#### 7. IPFS 集成模块
```typescript
interface IPFSService {
  // 文件上传
  uploadFile: (file: File, metadata?: FileMetadata) => Promise<string>
  uploadFiles: (files: File[]) => Promise<string[]>
  
  // JSON数据上传
  uploadJSON: (data: any, metadata?: JSONMetadata) => Promise<string>
  
  // 从IPFS获取数据
  getFromIPFS: (hash: string) => Promise<any>
  
  // 批量操作
  uploadBatch: (items: UploadItem[]) => Promise<UploadResult[]>
  
  // 元数据管理
  updateMetadata: (hash: string, metadata: any) => Promise<string>
  
  // 内容验证
  verifyContent: (hash: string, expectedType: string) => Promise<boolean>
  
  // 网关管理
  getGateway: (hash: string) => string
  setGateway: (gateway: string) => void
}

interface FileMetadata {
  name: string
  type: string
  size: number
  description?: string
  tags?: string[]
  category: 'profile' | 'project' | 'hackathon' | 'certificate'
}
```

## 数据库设计

### 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE,
  avatar_url TEXT,
  bio TEXT,
  wallet_address VARCHAR(42),
  reputation_score INTEGER DEFAULT 0,
  ipfs_profile_hash TEXT,
  social_links JSONB,
  privacy_settings JSONB DEFAULT '{}',
  notification_settings JSONB DEFAULT '{}',
  web3_assets JSONB DEFAULT '{}',
  email_verified BOOLEAN DEFAULT FALSE,
  wallet_verified BOOLEAN DEFAULT FALSE,
  chain_id INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 用户技能表 (user_skills)
```sql
CREATE TABLE user_skills (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  level VARCHAR(20) DEFAULT 'intermediate',
  category VARCHAR(50) DEFAULT 'programming',
  blockchain_verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, name)
);
```

#### 黑客松表 (hackathons)
```sql
CREATE TABLE hackathons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  start_date TIMESTAMP NOT NULL,
  end_date TIMESTAMP NOT NULL,
  registration_deadline TIMESTAMP,
  status VARCHAR(20) DEFAULT 'draft',
  organizer_id UUID REFERENCES users(id),
  organizer_address VARCHAR(42),
  ipfs_hash TEXT,
  contract_address VARCHAR(42),
  metadata JSONB,
  prizes JSONB,
  tracks JSONB,
  rules TEXT,
  requirements JSONB,
  chain_id INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 项目表 (projects)
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  hackathon_id UUID REFERENCES hackathons(id) ON DELETE CASCADE,
  team_id UUID REFERENCES teams(id),
  track VARCHAR(100),
  github_url TEXT,
  demo_url TEXT,
  video_url TEXT,
  presentation_url TEXT,
  ipfs_hash TEXT,
  contract_address VARCHAR(42),
  status VARCHAR(20) DEFAULT 'draft',
  tags JSONB DEFAULT '[]',
  technologies JSONB DEFAULT '[]',
  nft_certificate VARCHAR(42),
  chain_id INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### DAO提案表 (dao_proposals)
```sql
CREATE TABLE dao_proposals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  proposer_address VARCHAR(42) NOT NULL,
  proposal_type VARCHAR(50) NOT NULL,
  target_contract VARCHAR(42),
  calldata TEXT,
  for_votes BIGINT DEFAULT 0,
  against_votes BIGINT DEFAULT 0,
  executed BOOLEAN DEFAULT FALSE,
  executed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### NFT证书表 (nft_certificates)
```sql
CREATE TABLE nft_certificates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  token_id VARCHAR(255) UNIQUE NOT NULL,
  contract_address VARCHAR(42) NOT NULL,
  owner_address VARCHAR(42) NOT NULL,
  certificate_type VARCHAR(50) NOT NULL,
  metadata JSONB,
  ipfs_hash TEXT,
  minted_at TIMESTAMP DEFAULT NOW(),
  transferred_at TIMESTAMP,
  chain_id INTEGER DEFAULT 1
);
```

#### 质押记录表 (staking_records)
```sql
CREATE TABLE staking_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_address VARCHAR(42) NOT NULL,
  amount DECIMAL(20, 8) NOT NULL,
  staking_type VARCHAR(50) NOT NULL,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  rewards_claimed DECIMAL(20, 8) DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active',
  transaction_hash VARCHAR(66),
  chain_id INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## API 设计

### RESTful API 端点

#### 用户相关
```
GET    /api/users/profile          # 获取用户资料
PUT    /api/users/profile          # 更新用户资料
GET    /api/users/:id              # 获取用户详情
GET    /api/users/:id/projects     # 获取用户项目
GET    /api/users/:id/hackathons   # 获取用户参与的黑客松
POST   /api/auth/signin           # 邮箱登录
POST   /api/auth/signup           # 邮箱注册
POST   /api/auth/wallet           # 钱包连接
POST   /api/auth/social           # 社交登录
POST   /api/auth/signout          # 登出
POST   /api/auth/verify-email     # 邮箱验证
POST   /api/auth/reset-password   # 重置密码
POST   /api/auth/verify-wallet    # 钱包验证
```

#### 黑客松相关
```
GET    /api/hackathons            # 获取黑客松列表
GET    /api/hackathons/:id        # 获取黑客松详情
POST   /api/hackathons            # 创建黑客松
PUT    /api/hackathons/:id        # 更新黑客松
DELETE /api/hackathons/:id        # 删除黑客松
GET    /api/hackathons/:id/projects # 获取黑客松项目
GET    /api/hackathons/:id/participants # 获取参与者
POST   /api/hackathons/:id/register # 注册参与
POST   /api/hackathons/:id/judges # 添加评委
GET    /api/hackathons/:id/chain-data # 获取链上数据
```

#### 项目相关
```
GET    /api/projects              # 获取项目列表
GET    /api/projects/:id          # 获取项目详情
POST   /api/projects              # 创建项目
PUT    /api/projects/:id          # 更新项目
DELETE /api/projects/:id          # 删除项目
POST   /api/projects/:id/submit   # 提交项目
GET    /api/projects/:id/scores   # 获取项目评分
POST   /api/projects/:id/scores   # 提交评分
GET    /api/projects/:id/chain-data # 获取链上数据
```

#### Web3相关
```
GET    /api/web3/dao/proposals    # 获取DAO提案
POST   /api/web3/dao/proposals    # 创建DAO提案
POST   /api/web3/dao/proposals/:id/vote # 投票
POST   /api/web3/dao/proposals/:id/execute # 执行提案
GET    /api/web3/dao/voting-power # 获取投票权
GET    /api/web3/nfts             # 获取NFT列表
POST   /api/web3/nfts/mint        # 铸造NFT
GET    /api/web3/staking/info     # 获取质押信息
POST   /api/web3/staking/stake    # 质押代币
POST   /api/web3/staking/unstake  # 解除质押
POST   /api/web3/staking/claim    # 领取奖励
```

#### IPFS 相关
```
POST   /api/ipfs/upload           # 上传文件到IPFS
POST   /api/ipfs/upload-json      # 上传JSON到IPFS
GET    /api/ipfs/:hash            # 获取IPFS数据
POST   /api/ipfs/batch-upload     # 批量上传
GET    /api/ipfs/verify/:hash     # 验证IPFS内容
GET    /api/ipfs/gateways         # 获取可用网关
```

#### 搜索相关
```
GET    /api/search/hackathons     # 搜索黑客松
GET    /api/search/projects       # 搜索项目
GET    /api/search/users          # 搜索用户
GET    /api/search/suggestions    # 搜索建议
GET    /api/search/blockchain     # 区块链数据搜索
```

## 前端页面结构

### 页面路由设计
```
/                           # 首页 - 黑客松发现
/hackathons                 # 黑客松列表
/hackathons/[id]            # 黑客松详情
/hackathons/[id]/projects   # 项目展示
/hackathons/[id]/submit     # 项目提交
/hackathons/[id]/judges     # 评委页面
/projects/[id]              # 项目详情
/teams                      # 团队管理
/profile                    # 用户资料
/dashboard                  # 用户仪表盘
/web3                       # Web3功能页面
/web3/dao                   # DAO治理
/web3/nfts                  # NFT证书
/web3/staking               # 质押奖励
/admin                      # 管理员面板
/search                     # 搜索页面
/ipfs                       # IPFS浏览器
```

### 组件架构
```
components/
├── ui/                     # 基础UI组件
│   ├── Button.tsx
│   ├── Card.tsx
│   ├── Input.tsx
│   ├── Modal.tsx
│   ├── Tabs.tsx
│   └── ...
├── layout/                 # 布局组件
│   ├── Header.tsx
│   ├── Sidebar.tsx
│   ├── Footer.tsx
│   └── Navigation.tsx
├── hackathon/              # 黑客松相关组件
│   ├── HackathonCard.tsx
│   ├── HackathonDetail.tsx
│   ├── HackathonForm.tsx
│   ├── HackathonList.tsx
│   └── HackathonHero.tsx
├── project/                # 项目相关组件
│   ├── ProjectCard.tsx
│   ├── ProjectForm.tsx
│   ├── ProjectList.tsx
│   ├── ProjectDetail.tsx
│   └── ProjectSubmission.tsx
├── web3/                   # Web3相关组件
│   ├── WalletConnect.tsx
│   ├── DAOGovernance.tsx
│   ├── NFTCertificates.tsx
│   ├── TokenStaking.tsx
│   └── BlockchainData.tsx
├── ipfs/                   # IPFS相关组件
│   ├── IPFSBrowser.tsx
│   ├── IPFSUpload.tsx
│   ├── IPFSViewer.tsx
│   └── IPFSVerifier.tsx
├── common/                 # 通用组件
│   ├── SearchBar.tsx
│   ├── FilterPanel.tsx
│   ├── Pagination.tsx
│   ├── LoadingSpinner.tsx
│   └── ErrorBoundary.tsx
└── forms/                  # 表单组件
    ├── HackathonForm.tsx
    ├── ProjectForm.tsx
    ├── TeamForm.tsx
    └── UserForm.tsx
```

## 智能合约架构

### 合约设计原则
1. **模块化设计**: 功能分离，便于维护和升级
2. **Gas优化**: 最小化Gas消耗
3. **安全第一**: 遵循安全最佳实践
4. **可升级性**: 支持合约升级
5. **事件驱动**: 完整的事件记录

### 核心合约
```solidity
// HackXCore.sol - 核心合约
contract HackXCore is Ownable, ReentrancyGuard {
    // 状态变量
    mapping(address => string) public userProfiles;
    mapping(uint256 => string) public hackathonData;
    mapping(uint256 => string) public projectData;
    mapping(uint256 => mapping(address => string)) public projectSubmissions;
    mapping(uint256 => address[]) public hackathonParticipants;
    mapping(address => uint256[]) public userHackathons;
    
    // 计数器
    uint256 public hackathonCount;
    uint256 public projectCount;
    
    // 事件
    event UserRegistered(address indexed user, string profileCID);
    event ProfileUpdated(address indexed user, string newProfileCID);
    event HackathonCreated(uint256 indexed hackathonId, address indexed organizer, string dataCID);
    event HackathonUpdated(uint256 indexed hackathonId, string newDataCID);
    event ParticipantJoined(uint256 indexed hackathonId, address indexed participant);
    event ParticipantLeft(uint256 indexed hackathonId, address indexed participant);
    event ProjectSubmitted(uint256 indexed projectId, address indexed submitter, string dataCID);
    event ProjectUpdated(uint256 indexed projectId, string newDataCID);
    event ScoreSubmitted(uint256 indexed projectId, address indexed judge, uint256 score);
    
    // 修饰符
    modifier userExists(address user) {
        require(bytes(userProfiles[user]).length > 0, "User not registered");
        _;
    }
    
    modifier hackathonExists(uint256 hackathonId) {
        require(bytes(hackathonData[hackathonId]).length > 0, "Hackathon not found");
        _;
    }
    
    modifier onlyHackathonOrganizer(uint256 hackathonId) {
        // 实现组织者权限检查
        _;
    }
    
    // 核心功能
    function registerUser(string memory profileCID) external {
        require(bytes(profileCID).length > 0, "Profile CID cannot be empty");
        require(bytes(userProfiles[msg.sender]).length == 0, "User already registered");
        
        userProfiles[msg.sender] = profileCID;
        emit UserRegistered(msg.sender, profileCID);
    }
    
    function createHackathon(string memory hackathonDataCID) external returns (uint256) {
        require(bytes(hackathonDataCID).length > 0, "Hackathon data CID cannot be empty");
        
        hackathonCount++;
        uint256 hackathonId = hackathonCount;
        hackathonData[hackathonId] = hackathonDataCID;
        
        emit HackathonCreated(hackathonId, msg.sender, hackathonDataCID);
        return hackathonId;
    }
    
    function submitProject(uint256 hackathonId, string memory projectDataCID) 
        external 
        hackathonExists(hackathonId) 
        returns (uint256) 
    {
        require(bytes(projectDataCID).length > 0, "Project data CID cannot be empty");
        
        projectCount++;
        uint256 projectId = projectCount;
        projectData[projectId] = projectDataCID;
        projectSubmissions[hackathonId][msg.sender] = projectDataCID;
        
        emit ProjectSubmitted(projectId, msg.sender, projectDataCID);
        return projectId;
    }
    
    // 查询功能
    function getUserProfile(address user) external view returns (string memory) {
        return userProfiles[user];
    }
    
    function getHackathonData(uint256 hackathonId) external view returns (string memory) {
        return hackathonData[hackathonId];
    }
    
    function getProjectData(uint256 projectId) external view returns (string memory) {
        return projectData[projectId];
    }
}
```

## IPFS 集成方案

### 存储策略
1. **用户资料**: 存储在IPFS，数据库只保存哈希
2. **项目文件**: 代码、演示视频、文档等上传到IPFS
3. **黑客松元数据**: 活动详情、规则等存储在IPFS
4. **评委反馈**: 评分和评论存储在IPFS
5. **NFT元数据**: NFT证书元数据存储在IPFS

### 实现方案
```typescript
// IPFS服务实现
class IPFSService {
  private pinata: PinataSDK;
  private gateways: string[];
  
  constructor() {
    this.pinata = new PinataSDK({
      pinataApiKey: process.env.PINATA_API_KEY,
      pinataSecretApiKey: process.env.PINATA_SECRET_API_KEY
    });
    
    this.gateways = [
      'https://gateway.pinata.cloud/ipfs/',
      'https://ipfs.io/ipfs/',
      'https://cloudflare-ipfs.com/ipfs/'
    ];
  }
  
  async uploadFile(file: File, metadata?: FileMetadata): Promise<string> {
    const formData = new FormData();
    formData.append('file', file);
    
    if (metadata) {
      formData.append('pinataMetadata', JSON.stringify(metadata));
    }
    
    const result = await this.pinata.pinFileToIPFS(formData);
    return result.IpfsHash;
  }
  
  async uploadJSON(data: any, metadata?: JSONMetadata): Promise<string> {
    const result = await this.pinata.pinJSONToIPFS(data, {
      pinataMetadata: metadata
    });
    return result.IpfsHash;
  }
  
  async uploadBatch(items: UploadItem[]): Promise<UploadResult[]> {
    const results = await Promise.all(
      items.map(item => 
        item.type === 'file' 
          ? this.uploadFile(item.file, item.metadata)
          : this.uploadJSON(item.data, item.metadata)
      )
    );
    
    return results.map((hash, index) => ({
      hash,
      originalItem: items[index]
    }));
  }
  
  async verifyContent(hash: string, expectedType: string): Promise<boolean> {
    try {
      const response = await fetch(`https://gateway.pinata.cloud/ipfs/${hash}`);
      const contentType = response.headers.get('content-type');
      return contentType?.includes(expectedType) || false;
    } catch (error) {
      return false;
    }
  }
  
  getGateway(hash: string): string {
    // 智能选择最佳网关
    return this.gateways[0] + hash;
  }
}
```

## The Graph 集成

### 子图设计
```graphql
# schema.graphql
type User @entity {
  id: ID!
  address: Bytes!
  profileCID: String
  reputationScore: BigInt
  hackathons: [HackathonParticipant!]! @derivedFrom(field: "participant")
  projects: [Project!]! @derivedFrom(field: "submitter")
  createdAt: BigInt!
  updatedAt: BigInt!
}

type Hackathon @entity {
  id: ID!
  hackathonId: BigInt!
  organizer: Bytes!
  dataCID: String!
  participants: [HackathonParticipant!]! @derivedFrom(field: "hackathon")
  projects: [Project!]! @derivedFrom(field: "hackathonId")
  createdAt: BigInt!
  updatedAt: BigInt!
}

type Project @entity {
  id: ID!
  projectId: BigInt!
  hackathonId: BigInt!
  submitter: Bytes!
  dataCID: String!
  scores: [Score!]! @derivedFrom(field: "project")
  createdAt: BigInt!
  updatedAt: BigInt!
}

type Score @entity {
  id: ID!
  project: Project!
  judge: Bytes!
  score: BigInt!
  createdAt: BigInt!
}

type HackathonParticipant @entity {
  id: ID!
  hackathon: Hackathon!
  participant: User!
  joinedAt: BigInt!
}
```

### 事件处理
```typescript
// mapping.ts
import { BigInt, Address } from "@graphprotocol/graph-ts"
import {
  UserRegistered,
  HackathonCreated,
  ProjectSubmitted,
  ScoreSubmitted
} from "../generated/HackXCore/HackXCore"
import { User, Hackathon, Project, Score } from "../generated/schema"

export function handleUserRegistered(event: UserRegistered): void {
  let user = new User(event.params.user.toHexString())
  user.address = event.params.user
  user.profileCID = event.params.profileCID
  user.reputationScore = BigInt.fromI32(0)
  user.createdAt = event.block.timestamp
  user.updatedAt = event.block.timestamp
  user.save()
}

export function handleHackathonCreated(event: HackathonCreated): void {
  let hackathon = new Hackathon(event.params.hackathonId.toString())
  hackathon.hackathonId = event.params.hackathonId
  hackathon.organizer = event.params.organizer
  hackathon.dataCID = event.params.dataCID
  hackathon.createdAt = event.block.timestamp
  hackathon.updatedAt = event.block.timestamp
  hackathon.save()
}

export function handleProjectSubmitted(event: ProjectSubmitted): void {
  let project = new Project(event.params.projectId.toString())
  project.projectId = event.params.projectId
  project.submitter = event.params.submitter
  project.dataCID = event.params.dataCID
  project.createdAt = event.block.timestamp
  project.updatedAt = event.block.timestamp
  project.save()
}
```

## 实时功能实现

### WebSocket 集成
```typescript
// 实时通知服务
class NotificationService {
  private socket: Socket;
  
  constructor() {
    this.socket = io(process.env.NEXT_PUBLIC_WS_URL);
    this.setupEventListeners();
  }
  
  private setupEventListeners() {
    this.socket.on('project_submitted', (data) => {
      // 处理项目提交通知
    });
    
    this.socket.on('score_updated', (data) => {
      // 处理评分更新通知
    });
    
    this.socket.on('hackathon_started', (data) => {
      // 处理黑客松开始通知
    });
    
    this.socket.on('dao_proposal_created', (data) => {
      // 处理DAO提案创建通知
    });
    
    this.socket.on('nft_minted', (data) => {
      // 处理NFT铸造通知
    });
  }
  
  // 发送通知
  sendNotification(userId: string, type: string, data: any) {
    this.socket.emit('notification', { userId, type, data });
  }
}
```

## 部署方案

### 开发环境
- **前端**: `npm run dev` (localhost:3000)
- **后端**: Next.js API Routes
- **数据库**: 本地PostgreSQL或Supabase
- **IPFS**: Pinata测试环境
- **智能合约**: Hardhat本地网络
- **The Graph**: 本地Graph节点

### 生产环境
- **前端**: Vercel部署
- **后端**: Vercel Serverless Functions
- **数据库**: Supabase或PlanetScale
- **IPFS**: Pinata生产环境
- **智能合约**: Polygon主网
- **The Graph**: The Graph托管服务
- **CDN**: Vercel Edge Network
- **实时服务**: Pusher或Socket.io Cloud

### 环境变量配置
```env
# 数据库
DATABASE_URL=postgresql://...
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# IPFS
PINATA_API_KEY=...
PINATA_SECRET_API_KEY=...

# 认证
NEXTAUTH_SECRET=...
NEXTAUTH_URL=...

# Web3
NEXT_PUBLIC_CHAIN_ID=137
NEXT_PUBLIC_RPC_URL=...
NEXT_PUBLIC_CONTRACT_ADDRESS=...

# The Graph
NEXT_PUBLIC_SUBGRAPH_URL=...

# 邮件服务
RESEND_API_KEY=...
SENDGRID_API_KEY=...

# 实时服务
PUSHER_APP_ID=...
PUSHER_KEY=...
PUSHER_SECRET=...

# 监控
SENTRY_DSN=...
```

## 开发流程

### 1. 项目初始化
```bash
# 创建Next.js项目
npx create-next-app@latest hackx-platform --typescript --tailwind --app

# 安装依赖
npm install @prisma/client @auth/prisma-adapter zustand react-hook-form zod
npm install @radix-ui/react-* lucide-react framer-motion
npm install pinata-sdk ethers viem socket.io-client
npm install resend @sendgrid/mail

# 初始化Prisma
npx prisma init

# 初始化Hardhat
npx hardhat init
```

### 2. 开发阶段
1. **智能合约开发**: 编写和测试智能合约
2. **数据库设计**: 创建Prisma schema
3. **API开发**: 实现RESTful API
4. **前端开发**: 实现页面和组件
5. **IPFS集成**: 实现文件上传功能
6. **Web3集成**: 实现钱包连接和合约交互
7. **The Graph集成**: 部署子图和查询
8. **测试**: 单元测试和集成测试

### 3. 部署阶段
1. **代码审查**: GitHub PR审查
2. **CI/CD**: GitHub Actions自动化部署
3. **环境配置**: 生产环境变量设置
4. **监控**: 性能监控和错误追踪

## 性能优化

### 前端优化
- Next.js App Router的SSR/SSG
- 图片优化和懒加载
- 代码分割和动态导入
- 缓存策略
- 骨架屏加载
- IPFS网关优化

### 后端优化
- API路由缓存
- 数据库查询优化
- Redis缓存热点数据
- IPFS网关选择
- 连接池配置
- GraphQL查询优化

### 区块链优化
- Gas费用优化
- 批量操作
- 事件索引优化
- 合约升级策略

## 安全考虑

### 智能合约安全
- 专业安全审计
- 重入攻击防护
- 整数溢出检查
- 权限控制
- 紧急暂停功能

### 认证安全
- JWT token管理
- 密码加密存储
- 钱包签名验证
- 会话管理
- 多因素认证

### 数据安全
- SQL注入防护
- XSS防护
- CSRF防护
- 文件上传安全
- 数据加密
- IPFS内容验证

## 监控和日志

### 应用监控
- Vercel Analytics
- 错误追踪 (Sentry)
- 性能监控
- 用户行为分析
- 实时告警
- 区块链交易监控

### 日志管理
- 结构化日志
- 错误日志收集
- 审计日志
- 性能日志
- 安全日志
- 区块链事件日志

## 成功指标

### 技术指标
- 智能合约部署成功率：100%
- IPFS数据可用性：>99.9%
- The Graph查询响应时间：<1秒
- 钱包连接成功率：>95%
- 交易成功率：>98%
- Gas费用优化：<50%减少

### 用户指标
- 注册用户数：10,000+
- 活跃用户数：5,000+
- 用户留存率：>60%
- 用户满意度：>4.5/5.0
- Web3用户占比：>70%
- 钱包连接率：>80%

### 业务指标
- 黑客松数量：100+
- 项目提交数：1,000+
- 完成率：>80%
- 平台收入：$50K+
- 治理参与率：>30%
- NFT铸造数：5,000+

### 社区指标
- Discord成员：10,000+
- Twitter关注者：20,000+
- GitHub星标：2,000+
- 合作伙伴：50+
- DAO提案数：100+
- 质押参与率：>40%

这个更新后的技术方案反映了HackX平台向完全去中心化架构的转变，突出了智能合约、IPFS、The Graph等Web3技术的深度集成。 