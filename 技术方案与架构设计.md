# HackX 黑客松平台 - 技术方案与架构设计

## 项目概述

基于 IPFS 的去中心化黑客松平台，支持黑客松创建、项目提交、用户管理等功能，服务全球数百万开发者。

### 产品愿景
构建首个完全基于 IPFS 的开源黑客松平台，支持 100+ 场黑客松、服务全球数百万开发者。

### 核心用户群体
- **黑客松参与者 (Developer)**: 18-35岁，软件开发者、学生、创业者
- **黑客松组织者 (Organizer)**: 25-45岁，技术公司、投资机构负责人
- **评委 (Judge)**: 30-50岁，技术专家、投资人、行业领袖
- **投资者/企业 (Investor)**: 35-60岁，风险投资人、企业技术负责人

## 技术栈选择

### 前端技术栈
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS + shadcn/ui
- **状态管理**: Zustand
- **表单处理**: React Hook Form + Zod
- **UI组件**: Radix UI
- **图标**: Lucide React
- **动画**: Framer Motion
- **实时通信**: Socket.io / Pusher

### 后端技术栈
- **运行时**: Node.js
- **框架**: Next.js API Routes
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **文件存储**: IPFS (通过 Pinata API)
- **认证**: NextAuth.js
- **Web3集成**: ethers.js / viem
- **邮件服务**: Resend / SendGrid
- **通知服务**: WebPush API

### 基础设施
- **部署**: Vercel (前端) + Railway (后端)
- **数据库**: Supabase / PlanetScale
- **IPFS网关**: Pinata / Infura
- **监控**: Vercel Analytics + Sentry
- **CI/CD**: GitHub Actions
- **CDN**: Vercel Edge Network

## 系统架构设计

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Next.js) │    │   后端 (API)    │    │   数据库层      │
│                 │    │                 │    │                 │
│ - 用户界面      │◄──►│ - REST API      │◄──►│ - PostgreSQL    │
│ - 状态管理      │    │ - 认证授权      │    │ - Redis缓存     │
│ - 路由管理      │    │ - 业务逻辑      │    │ - 文件存储      │
│ - 实时通信      │    │ - 实时服务      │    │ - 搜索索引      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   IPFS 存储     │    │   Web3 集成     │    │   外部服务      │
│                 │    │                 │    │                 │
│ - 项目文件      │    │ - 钱包连接      │    │ - 邮件服务      │
│ - 用户资料      │    │ - 智能合约      │    │ - 通知服务      │
│ - 活动数据      │    │ - 链上验证      │    │ - 分析服务      │
│ - 评审反馈      │    │ - NFT证书       │    │ - 支付服务      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 核心模块设计

#### 1. 用户认证模块
```typescript
// 多认证方式支持
interface AuthFlow {
  // 传统邮箱认证
  emailAuth: {
    signIn: (email: string, password: string) => Promise<User>
    signUp: (userData: UserRegistration) => Promise<User>
    resetPassword: (email: string) => Promise<void>
    verifyEmail: (token: string) => Promise<boolean>
  }
  
  // Web3钱包认证
  web3Auth: {
    connectWallet: (provider: 'metamask' | 'walletconnect') => Promise<User>
    verifySignature: (message: string, signature: string) => Promise<boolean>
    linkWallet: (walletAddress: string) => Promise<void>
  }
  
  // 社交登录
  socialAuth: {
    signInWithGitHub: () => Promise<User>
    signInWithGoogle: () => Promise<User>
    linkSocialAccount: (provider: string, accountId: string) => Promise<void>
  }
}
```

#### 2. 黑客松管理模块
```typescript
interface Hackathon {
  id: string
  title: string
  description: string
  startDate: Date
  endDate: Date
  registrationDeadline: Date
  status: 'draft' | 'upcoming' | 'ongoing' | 'ended'
  organizerId: string
  prizes: Prize[]
  judges: Judge[]
  tracks: Track[]
  rules: string
  requirements: string[]
  ipfsHash: string // IPFS存储哈希
  metadata: HackathonMetadata
  participants: Participant[]
  projects: Project[]
}

interface HackathonMetadata {
  coverImage: string
  bannerImage: string
  socialLinks: SocialLinks
  sponsors: Sponsor[]
  schedule: ScheduleItem[]
  judgingCriteria: JudgingCriteria[]
  submissionGuidelines: string
  faq: FAQItem[]
}
```

#### 3. 项目提交模块
```typescript
interface Project {
  id: string
  name: string
  description: string
  team: TeamMember[]
  hackathonId: string
  track: string
  githubUrl?: string
  demoUrl?: string
  videoUrl?: string
  presentationUrl?: string
  ipfsHash: string // 项目文件IPFS哈希
  status: 'draft' | 'submitted' | 'under_review' | 'approved' | 'rejected'
  scores: Score[]
  feedback: Feedback[]
  tags: string[]
  technologies: string[]
  createdAt: Date
  updatedAt: Date
}

interface TeamMember {
  id: string
  userId: string
  role: 'leader' | 'developer' | 'designer' | 'other'
  contribution: string
  joinedAt: Date
}
```

#### 4. 用户管理模块
```typescript
interface User {
  id: string
  email: string
  username: string
  avatarUrl?: string
  bio?: string
  walletAddress?: string
  reputationScore: number
  badges: Badge[]
  skills: Skill[]
  socialLinks: SocialLinks
  ipfsProfileHash: string
  privacySettings: PrivacySettings
  notificationSettings: NotificationSettings
  createdAt: Date
  updatedAt: Date
}

interface Skill {
  id: string
  name: string
  level: 'beginner' | 'intermediate' | 'advanced' | 'expert'
  category: 'programming' | 'design' | 'business' | 'other'
}
```

#### 5. 评审系统模块
```typescript
interface Judge {
  id: string
  userId: string
  hackathonId: string
  role: 'main' | 'technical' | 'business' | 'design'
  expertise: string[]
  assignedProjects: string[]
  scores: Score[]
}

interface Score {
  id: string
  projectId: string
  judgeId: string
  criteria: string
  score: number
  maxScore: number
  comment?: string
  createdAt: Date
}

interface Feedback {
  id: string
  projectId: string
  judgeId: string
  type: 'technical' | 'business' | 'design' | 'general'
  content: string
  isPublic: boolean
  createdAt: Date
}
```

#### 6. IPFS 集成模块
```typescript
interface IPFSService {
  // 文件上传
  uploadFile: (file: File, metadata?: FileMetadata) => Promise<string>
  uploadFiles: (files: File[]) => Promise<string[]>
  
  // JSON数据上传
  uploadJSON: (data: any, metadata?: JSONMetadata) => Promise<string>
  
  // 从IPFS获取数据
  getFromIPFS: (hash: string) => Promise<any>
  
  // 批量操作
  uploadBatch: (items: UploadItem[]) => Promise<UploadResult[]>
  
  // 元数据管理
  updateMetadata: (hash: string, metadata: any) => Promise<string>
  
  // 内容验证
  verifyContent: (hash: string, expectedType: string) => Promise<boolean>
}

interface FileMetadata {
  name: string
  type: string
  size: number
  description?: string
  tags?: string[]
}
```

## 数据库设计

### 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE,
  avatar_url TEXT,
  bio TEXT,
  wallet_address VARCHAR(42),
  reputation_score INTEGER DEFAULT 0,
  ipfs_profile_hash TEXT,
  social_links JSONB,
  privacy_settings JSONB DEFAULT '{}',
  notification_settings JSONB DEFAULT '{}',
  email_verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 用户技能表 (user_skills)
```sql
CREATE TABLE user_skills (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  level VARCHAR(20) DEFAULT 'intermediate',
  category VARCHAR(50) DEFAULT 'programming',
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, name)
);
```

#### 黑客松表 (hackathons)
```sql
CREATE TABLE hackathons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  start_date TIMESTAMP NOT NULL,
  end_date TIMESTAMP NOT NULL,
  registration_deadline TIMESTAMP,
  status VARCHAR(20) DEFAULT 'draft',
  organizer_id UUID REFERENCES users(id),
  ipfs_hash TEXT,
  metadata JSONB,
  prizes JSONB,
  tracks JSONB,
  rules TEXT,
  requirements JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 项目表 (projects)
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  hackathon_id UUID REFERENCES hackathons(id) ON DELETE CASCADE,
  team_id UUID REFERENCES teams(id),
  track VARCHAR(100),
  github_url TEXT,
  demo_url TEXT,
  video_url TEXT,
  presentation_url TEXT,
  ipfs_hash TEXT,
  status VARCHAR(20) DEFAULT 'draft',
  tags JSONB DEFAULT '[]',
  technologies JSONB DEFAULT '[]',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 团队表 (teams)
```sql
CREATE TABLE teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  leader_id UUID REFERENCES users(id),
  max_members INTEGER DEFAULT 4,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 团队成员表 (team_members)
```sql
CREATE TABLE team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID REFERENCES teams(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(50) DEFAULT 'member',
  contribution TEXT,
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(team_id, user_id)
);
```

#### 评委表 (judges)
```sql
CREATE TABLE judges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  hackathon_id UUID REFERENCES hackathons(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id),
  role VARCHAR(50) DEFAULT 'main',
  expertise JSONB DEFAULT '[]',
  assigned_projects JSONB DEFAULT '[]',
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 评分表 (scores)
```sql
CREATE TABLE scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  judge_id UUID REFERENCES judges(id) ON DELETE CASCADE,
  criteria VARCHAR(100) NOT NULL,
  score INTEGER NOT NULL,
  max_score INTEGER NOT NULL,
  comment TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 反馈表 (feedback)
```sql
CREATE TABLE feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  judge_id UUID REFERENCES judges(id) ON DELETE CASCADE,
  type VARCHAR(50) DEFAULT 'general',
  content TEXT NOT NULL,
  is_public BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## API 设计

### RESTful API 端点

#### 用户相关
```
GET    /api/users/profile          # 获取用户资料
PUT    /api/users/profile          # 更新用户资料
GET    /api/users/:id              # 获取用户详情
GET    /api/users/:id/projects     # 获取用户项目
GET    /api/users/:id/hackathons   # 获取用户参与的黑客松
POST   /api/auth/signin           # 邮箱登录
POST   /api/auth/signup           # 邮箱注册
POST   /api/auth/wallet           # 钱包连接
POST   /api/auth/social           # 社交登录
POST   /api/auth/signout          # 登出
POST   /api/auth/verify-email     # 邮箱验证
POST   /api/auth/reset-password   # 重置密码
```

#### 黑客松相关
```
GET    /api/hackathons            # 获取黑客松列表
GET    /api/hackathons/:id        # 获取黑客松详情
POST   /api/hackathons            # 创建黑客松
PUT    /api/hackathons/:id        # 更新黑客松
DELETE /api/hackathons/:id        # 删除黑客松
GET    /api/hackathons/:id/projects # 获取黑客松项目
GET    /api/hackathons/:id/participants # 获取参与者
POST   /api/hackathons/:id/register # 注册参与
POST   /api/hackathons/:id/judges # 添加评委
```

#### 项目相关
```
GET    /api/projects              # 获取项目列表
GET    /api/projects/:id          # 获取项目详情
POST   /api/projects              # 创建项目
PUT    /api/projects/:id          # 更新项目
DELETE /api/projects/:id          # 删除项目
POST   /api/projects/:id/submit   # 提交项目
GET    /api/projects/:id/scores   # 获取项目评分
POST   /api/projects/:id/scores   # 提交评分
```

#### 团队相关
```
GET    /api/teams                 # 获取团队列表
GET    /api/teams/:id             # 获取团队详情
POST   /api/teams                 # 创建团队
PUT    /api/teams/:id             # 更新团队
DELETE /api/teams/:id             # 删除团队
POST   /api/teams/:id/members     # 添加团队成员
DELETE /api/teams/:id/members/:userId # 移除团队成员
POST   /api/teams/:id/invite      # 邀请团队成员
```

#### IPFS 相关
```
POST   /api/ipfs/upload           # 上传文件到IPFS
POST   /api/ipfs/upload-json      # 上传JSON到IPFS
GET    /api/ipfs/:hash            # 获取IPFS数据
POST   /api/ipfs/batch-upload     # 批量上传
GET    /api/ipfs/verify/:hash     # 验证IPFS内容
```

#### 搜索相关
```
GET    /api/search/hackathons     # 搜索黑客松
GET    /api/search/projects       # 搜索项目
GET    /api/search/users          # 搜索用户
GET    /api/search/suggestions    # 搜索建议
```

## 前端页面结构

### 页面路由设计
```
/                           # 首页 - 黑客松发现
/hackathons                 # 黑客松列表
/hackathons/[id]            # 黑客松详情
/hackathons/[id]/projects   # 项目展示
/hackathons/[id]/submit     # 项目提交
/hackathons/[id]/judges     # 评委页面
/projects/[id]              # 项目详情
/teams                      # 团队管理
/profile                    # 用户资料
/dashboard                  # 用户仪表盘
/admin                      # 管理员面板
/search                     # 搜索页面
```

### 组件架构
```
components/
├── ui/                     # 基础UI组件
│   ├── Button.tsx
│   ├── Card.tsx
│   ├── Input.tsx
│   ├── Modal.tsx
│   ├── Tabs.tsx
│   └── ...
├── layout/                 # 布局组件
│   ├── Header.tsx
│   ├── Sidebar.tsx
│   ├── Footer.tsx
│   └── Navigation.tsx
├── hackathon/              # 黑客松相关组件
│   ├── HackathonCard.tsx
│   ├── HackathonDetail.tsx
│   ├── HackathonForm.tsx
│   ├── HackathonList.tsx
│   └── HackathonHero.tsx
├── project/                # 项目相关组件
│   ├── ProjectCard.tsx
│   ├── ProjectForm.tsx
│   ├── ProjectList.tsx
│   ├── ProjectDetail.tsx
│   └── ProjectSubmission.tsx
├── team/                   # 团队相关组件
│   ├── TeamCard.tsx
│   ├── TeamForm.tsx
│   ├── MemberList.tsx
│   └── TeamInvite.tsx
├── user/                   # 用户相关组件
│   ├── UserProfile.tsx
│   ├── UserCard.tsx
│   ├── SkillTags.tsx
│   └── BadgeDisplay.tsx
├── judge/                  # 评审相关组件
│   ├── JudgePanel.tsx
│   ├── ScoreForm.tsx
│   ├── FeedbackForm.tsx
│   └── ResultsDisplay.tsx
├── common/                 # 通用组件
│   ├── SearchBar.tsx
│   ├── FilterPanel.tsx
│   ├── Pagination.tsx
│   ├── LoadingSpinner.tsx
│   └── ErrorBoundary.tsx
└── forms/                  # 表单组件
    ├── HackathonForm.tsx
    ├── ProjectForm.tsx
    ├── TeamForm.tsx
    └── UserForm.tsx
```

## IPFS 集成方案

### 存储策略
1. **用户资料**: 存储在IPFS，数据库只保存哈希
2. **项目文件**: 代码、演示视频、文档等上传到IPFS
3. **黑客松元数据**: 活动详情、规则等存储在IPFS
4. **评委反馈**: 评分和评论存储在IPFS
5. **证书和徽章**: NFT形式的证书存储在IPFS

### 实现方案
```typescript
// IPFS服务实现
class IPFSService {
  private pinata: PinataSDK;
  
  constructor() {
    this.pinata = new PinataSDK({
      pinataApiKey: process.env.PINATA_API_KEY,
      pinataSecretApiKey: process.env.PINATA_SECRET_API_KEY
    });
  }
  
  async uploadFile(file: File, metadata?: FileMetadata): Promise<string> {
    const formData = new FormData();
    formData.append('file', file);
    
    if (metadata) {
      formData.append('pinataMetadata', JSON.stringify(metadata));
    }
    
    const result = await this.pinata.pinFileToIPFS(formData);
    return result.IpfsHash;
  }
  
  async uploadJSON(data: any, metadata?: JSONMetadata): Promise<string> {
    const result = await this.pinata.pinJSONToIPFS(data, {
      pinataMetadata: metadata
    });
    return result.IpfsHash;
  }
  
  async uploadBatch(items: UploadItem[]): Promise<UploadResult[]> {
    const results = await Promise.all(
      items.map(item => 
        item.type === 'file' 
          ? this.uploadFile(item.file, item.metadata)
          : this.uploadJSON(item.data, item.metadata)
      )
    );
    
    return results.map((hash, index) => ({
      hash,
      originalItem: items[index]
    }));
  }
  
  async verifyContent(hash: string, expectedType: string): Promise<boolean> {
    try {
      const response = await fetch(`https://gateway.pinata.cloud/ipfs/${hash}`);
      const contentType = response.headers.get('content-type');
      return contentType?.includes(expectedType) || false;
    } catch (error) {
      return false;
    }
  }
}
```

## 实时功能实现

### WebSocket 集成
```typescript
// 实时通知服务
class NotificationService {
  private socket: Socket;
  
  constructor() {
    this.socket = io(process.env.NEXT_PUBLIC_WS_URL);
    this.setupEventListeners();
  }
  
  private setupEventListeners() {
    this.socket.on('project_submitted', (data) => {
      // 处理项目提交通知
    });
    
    this.socket.on('score_updated', (data) => {
      // 处理评分更新通知
    });
    
    this.socket.on('hackathon_started', (data) => {
      // 处理黑客松开始通知
    });
  }
  
  // 发送通知
  sendNotification(userId: string, type: string, data: any) {
    this.socket.emit('notification', { userId, type, data });
  }
}
```

## 部署方案

### 开发环境
- **前端**: `npm run dev` (localhost:3000)
- **后端**: Next.js API Routes
- **数据库**: 本地PostgreSQL或Supabase
- **IPFS**: Pinata测试环境
- **实时服务**: Socket.io本地服务器

### 生产环境
- **前端**: Vercel部署
- **后端**: Vercel Serverless Functions
- **数据库**: Supabase或PlanetScale
- **IPFS**: Pinata生产环境
- **CDN**: Vercel Edge Network
- **实时服务**: Pusher或Socket.io Cloud

### 环境变量配置
```env
# 数据库
DATABASE_URL=postgresql://...
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# IPFS
PINATA_API_KEY=...
PINATA_SECRET_API_KEY=...

# 认证
NEXTAUTH_SECRET=...
NEXTAUTH_URL=...

# Web3
NEXT_PUBLIC_CHAIN_ID=1
NEXT_PUBLIC_RPC_URL=...

# 邮件服务
RESEND_API_KEY=...
SENDGRID_API_KEY=...

# 实时服务
PUSHER_APP_ID=...
PUSHER_KEY=...
PUSHER_SECRET=...

# 监控
SENTRY_DSN=...
```

## 开发流程

### 1. 项目初始化
```bash
# 创建Next.js项目
npx create-next-app@latest hackx-platform --typescript --tailwind --app

# 安装依赖
npm install @prisma/client @auth/prisma-adapter zustand react-hook-form zod
npm install @radix-ui/react-* lucide-react framer-motion
npm install pinata-sdk ethers viem socket.io-client
npm install resend @sendgrid/mail

# 初始化Prisma
npx prisma init
```

### 2. 开发阶段
1. **数据库设计**: 创建Prisma schema
2. **API开发**: 实现RESTful API
3. **前端开发**: 实现页面和组件
4. **IPFS集成**: 实现文件上传功能
5. **认证系统**: 实现多认证方式
6. **实时功能**: 实现WebSocket通信
7. **测试**: 单元测试和集成测试

### 3. 部署阶段
1. **代码审查**: GitHub PR审查
2. **CI/CD**: GitHub Actions自动化部署
3. **环境配置**: 生产环境变量设置
4. **监控**: 性能监控和错误追踪

## 性能优化

### 前端优化
- Next.js App Router的SSR/SSG
- 图片优化和懒加载
- 代码分割和动态导入
- 缓存策略
- 骨架屏加载

### 后端优化
- API路由缓存
- 数据库查询优化
- Redis缓存热点数据
- IPFS网关选择
- 连接池配置

### 数据库优化
- 索引优化
- 查询优化
- 读写分离
- 分页优化

## 安全考虑

### 认证安全
- JWT token管理
- 密码加密存储
- 钱包签名验证
- 会话管理
- 多因素认证

### 数据安全
- SQL注入防护
- XSS防护
- CSRF防护
- 文件上传安全
- 数据加密

### IPFS安全
- 文件类型验证
- 文件大小限制
- 内容哈希验证
- 访问控制
- 内容审核

## 监控和日志

### 应用监控
- Vercel Analytics
- 错误追踪 (Sentry)
- 性能监控
- 用户行为分析
- 实时告警

### 日志管理
- 结构化日志
- 错误日志收集
- 审计日志
- 性能日志
- 安全日志

## 成功指标

### 用户指标
- 注册用户数
- 活跃用户数
- 用户留存率
- 用户满意度
- 用户参与度

### 活动指标
- 黑客松数量
- 参与人数
- 项目提交数
- 完成率
- 评审质量

### 技术指标
- 页面加载速度
- API 响应时间
- 错误率
- 可用性
- IPFS上传成功率

这个更新后的技术方案更好地匹配了产品设计文档中的用户需求和功能要求，提供了更完整的技术实现指导。 